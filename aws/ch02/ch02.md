
# Template Provider

---

# Template
- exposes `data sources` to custom template
- to generate strings for other Terraform `resources` or `outputs`

---


# Define template

---

# Option 1 - Use template file
```
data "template_file" "init" {
  template = "${file("${path.module}/init.tpl")}"

  vars {
    consul_address = "${aws_instance.consul.private_ip}"
  }
}
```

## In `init.tpl`
```
#!/bin/bash
echo "CONSUL_ADDRESS = ${consul_address}" > /tmp/iplist
```

---

# Option 2 - Use inline template

```
data "template_file" "init" {
  template = "$${consul_address}:1234"

  vars {
    consul_address = "${aws_instance.consul.private_ip}"
  }
}
```
NOTE:
- `$${consul_address}`

---

# Attributes

- template
- vars
- `rendered`

https://www.terraform.io/docs/providers/template/d/file.html#attributes-reference

---


# Use template


---

Template output is stored in `rendered` :

```
output "dump" {
    value = "${data.template_file.my_output.rendered}"
}
```


---

## example: `aws/ch02/examples/2.1-template`
- Use `aws_instance` data source to get running instance
- Retrieve the `public_ip` of `aws_instance` and render template

---

Other provider: Github Provider
https://www.terraform.io/docs/providers/github/index.html

---

## example: `aws/ch02/examples/2.2-github-create-org-repo`
- Create Github access token
	-  https://github.com/settings/tokens/new

- Generate deployment key
	- `ssh-keygen -t rsa -f key`

---

# Null Provider

---

```
-/+ null_resource.cluster (new resource required)
      id:                            "3073545919705261159" => <computed> (forces new resource)
      triggers.%:                    "1" => "1"
      triggers.cluster_instance_ids: "i-0f87175b8613e3859" => "i-0e22c0e820fb5dd9b,i-0f87175b8613e3859" (forces new resource)
```

---


# Module

---

# Module
- Self-contained packages of Terraform configurations
- Manage configurations as a group
- Encapsulate their own resource
	- A resource in `A module` cannot directly depend on resources or attributes in `B module`
	- Export data through `outputs`

---

# How to create a module?
### Actually, you already created one.

---

# Root Module
- In working directory, you've `terraform apply`
- These files are composed as a valid module

---

# Use Module

---

# Module configuration
```
module "foo" {
  source  = "devopsdays/module1"
  servers = 3
  version = "<=0.0.5"
}
```
- Only configure module name, `foo`
- `terraform init` trigger module installation 

---

# Module configuration (cont.)
- `source`
	- [Terraform Registry](https://registry.terraform.io/)
	- Github, Bitbucket, S3, Generic Git/Mercurial ([doc](https://www.terraform.io/docs/modules/sources.html))
	- Local path
- `version`
	- Only support on
		- Terraform Registry
        - Terraform Enterprise's private module registry
	- constraint like: `>=`, `<=`, `~>`, `>=1.0.0, <=2.0.0`
		- ~> 1.2.`0`: any version >= 1.2.0 and < 1.3.0, e.g. 1.2.`X`
		- ~> 1.`2`: any version >= 1.2.0 and < 2.0.0, e.g. 1.`X.Y`

---

# Module output
- You cannot acces resource in module directly
- All neccessory data exported through `outputs`

### Reference a module output:

```
resource "example" "foo" {
  ami               = "ami-20180915"
  instance_type     = "t1.micro"
  server_ip = "${module.module_a.public_ip}"
}
```

---

# Create you own Module

---

# Creating Module
- Module = folder with Terraform files
- Keep provider at root module
- Standard structure:
    ```
    $ tree complete-module/
    .
    ├── README.md
    ├── main.tf
    ├── variables.tf
    ├── outputs.tf
    ├── ...
    ├── modules/
        ├── nestedA/
        │   ├── README.md
        │   ├── variables.tf
        │   ├── main.tf
        │   ├── outputs.tf
        ├── nestedB/
        ├── .../
    ```

---

## example: `aws/ch02/examples/2.4-a-simple-module`
- Create a module with a simple output
- Use the module and pass variable to a module
- Output the variable from the output of module
